<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Document Viewer</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
body { background:#111; color:#eee; padding:20px; font-family:Arial; }
a { color:#4af; margin-right:15px; }
a:hover { text-decoration:underline; }
mark { background:yellow; color:black; }

#viewer {
  background:#222;
  padding:20px;
  border-radius:6px;
  max-width:100%;
  white-space:pre-wrap;
  overflow-x:hidden;
  overflow-y:auto;
  height:75vh;
}

/* Finder box */
#finderBox {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #222;
  border: 1px solid #444;
  padding: 10px;
  border-radius: 6px;
  z-index: 9999;
}
</style>
</head>

<body>

<!-- HEADER -->
<h1 class="mb-4">Epstein Archive Search</h1>

<p>
  <a href="/">Search</a>
  <a href="/live">Live</a>
  <a href="/trump">Trump Only</a>
  <a href="/flightlogs">Flight Logs</a>
  <a href="/faces">Faces Only</a>
</p>

<!-- FIND BOX -->
<div id="finderBox">
  <input id="findTerm" type="text" placeholder="Find…" style="width:120px;">
  <span id="findPos">0 / 0</span>
  <button onclick="findPrev()">▲</button>
  <button onclick="findNext()">▼</button>
</div>

<h2>Viewing Document</h2>

<p>
  <b>File:</b> {{ row.real_file }}<br>
  <b>Fulltext file:</b> {{ row.fulltext_file }}<br>
  <b>Keywords:</b> {{ row.keywords }}<br>
  <b>Faces:</b> {{ row.has_faces }}<br>
</p>

<hr>

<div id="viewer">{{ text }}</div>

<!-- JAVASCRIPT: FIND + HIGHLIGHT -->
<script>
// Clear highlights
function clearMarks() {
  document.querySelectorAll("mark").forEach(m => {
    const parent = m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent), m);
    parent.normalize();
  });
}

// DOM-safe highlighter
function highlightSafe(term) {
  clearMarks();
  if (!term) return;

  const walker = document.createTreeWalker(
    document.getElementById("viewer"),
    NodeFilter.SHOW_TEXT,
    {
      acceptNode: (node) => {
        if (node.textContent.toLowerCase().includes(term.toLowerCase()))
            return NodeFilter.FILTER_ACCEPT;
        return NodeFilter.FILTER_SKIP;
      }
    }
  );

  let node;
  while (node = walker.nextNode()) {
    const span = document.createElement("span");
    span.innerHTML = node.textContent.replace(
      new RegExp(term, "gi"),
      match => `<mark>${match}</mark>`
    );
    node.parentNode.replaceChild(span, node);
  }
}

// Navigation
let Fhits = [];
let Findex = 0;

function updateCounter() {
  if (!Fhits.length)
    document.getElementById("findPos").innerText = "0 / 0";
  else
    document.getElementById("findPos").innerText = (Findex + 1) + " / " + Fhits.length;
}

function gotoHit() {
  if (!Fhits.length) return;
  Fhits[Findex].scrollIntoView({ behavior:"smooth", block:"center" });
}

function findNext() {
  if (!Fhits.length) return;
  Findex = (Findex + 1) % Fhits.length;
  gotoHit();
  updateCounter();
}

function findPrev() {
  if (!Fhits.length) return;
  Findex = (Findex - 1 + Fhits.length) % Fhits.length;
  gotoHit();
  updateCounter();
}

// On typing
document.getElementById("findTerm").addEventListener("input", e => {
  const term = e.target.value;
  highlightSafe(term);

  Fhits = [...document.querySelectorAll("mark")];
  Findex = 0;

  updateCounter();
  gotoHit();
});
</script>

</body>
</html>
