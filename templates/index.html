<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Epstein Archive Search</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
body { background:#111; color:#eee; padding:20px; font-family:Arial; }
a { color:#4af; margin-right:15px; }
a:hover { text-decoration:underline; }
mark { background:yellow; color:black; }

table { width:100%; border-collapse:collapse; margin-top:20px; }
td,th { padding:8px; border-bottom:1px solid #333; }
tr:hover { background:#222; }

#finderBox {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #222;
  border: 1px solid #444;
  padding: 10px;
  border-radius: 6px;
}
</style>

</head>
<body>

<h1 class="mb-4">Epstein Archive Search</h1>

<p>
  <a href="/">Search</a>
  <a href="/live">Live</a>
  <a href="/trump">Trump Only</a>
  <a href="/flightlogs">Flight Logs</a>
  <a href="/faces">Faces Only</a>
</p>

<form class="row g-3 mb-4" method="get">
  <div class="col-md-4">
    <label class="form-label">Search</label>
    <input type="text" name="q" value="{{ q or '' }}" class="form-control" placeholder="keyword…">
  </div>

  <div class="col-md-3">
    <label class="form-label">Keyword Contains</label>
    <input type="text" name="kw" value="{{ kw or '' }}" class="form-control" placeholder="e.g., trump">
  </div>

  <div class="col-md-3">
    <label class="form-label">Has Faces?</label>
    <select name="faces" class="form-select">
      <option value="">Any</option>
      <option value="1" {% if faces=='1' %}selected{% endif %}>Yes</option>
      <option value="0" {% if faces=='0' %}selected{% endif %}>No</option>
    </select>
  </div>

  <div class="col-md-2 d-flex align-items-end">
    <button class="btn btn-primary w-100" type="submit">Search</button>
  </div>
</form>

<p class="text-muted">Showing {{ rows|length }} result(s).</p>

<!-- FINDER BOX -->
<div id="finderBox">
  <input id="findTerm" type="text" placeholder="Find…" style="width:120px;">
  <span id="findPos">0 / 0</span>
  <button onclick="findPrev()">?</button>
  <button onclick="findNext()">?</button>
</div>

<table class="table table-striped table-dark table-sm">
  <thead>
    <tr>
      <th>File</th>
      <th>Keywords</th>
      <th>Names</th>
      <th>Dates</th>
      <th>Faces</th>
      <th>Snippet</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    <tr>
      <td style="max-width:300px; word-wrap:break-word;">
        {{ r.real_file }}<br>
        <small>Fulltext: <a href="/view/{{ r.id }}">{{ r.fulltext_file }}</a></small>
      </td>
      <td>{{ r.keywords }}</td>
      <td>{{ r.names }}</td>
      <td>{{ r.dates }}</td>
      <td>{{ r.has_faces }}</td>
      <td style="max-width:400px; word-wrap:break-word;">
        <small>{{ r.snippet }}</small>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- JAVASCRIPT -->
<script>
// Remove marks
function clearMarks() {
  document.querySelectorAll("mark").forEach(m => {
    const parent = m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent), m);
    parent.normalize();
  });
}

// DOM-safe global highlighter
function highlightSafe(term) {
  clearMarks();
  if (!term) return [];

  const hits = [];
  const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    {
      acceptNode(node) {
        // Skip finder UI
        if (node.parentNode && node.parentNode.closest("#finderBox")) {
          return NodeFilter.FILTER_REJECT;
        }

        // Only process text nodes containing our term
        return node.textContent.toLowerCase().includes(term.toLowerCase())
          ? NodeFilter.FILTER_ACCEPT
          : NodeFilter.FILTER_SKIP;
      }
    }
  );

  let node;
  while ((node = walker.nextNode())) {
    const span = document.createElement("span");
    span.innerHTML = node.textContent.replace(
      new RegExp(term, "gi"),
      match => `<mark>${match}</mark>`
    );

    // Replace node with span
    node.parentNode.replaceChild(span, node);

    // Save references to new <mark> elements
    span.querySelectorAll("mark").forEach(m => hits.push(m));
  }

  return hits;
}

let Fhits = [];
let Findex = 0;

function updateCounter() {
  const box = document.getElementById("findPos");
  if (!Fhits.length) {
    box.textContent = "0 / 0";
  } else {
    box.textContent = `${Findex + 1} / ${Fhits.length}`;
  }
}

function gotoHit() {
  if (!Fhits.length) return;
  Fhits[Findex].scrollIntoView({ behavior: "smooth", block: "center" });
}

function findNext() {
  if (!Fhits.length) return;
  Findex = (Findex + 1) % Fhits.length;
  gotoHit();
  updateCounter();
}

function findPrev() {
  if (!Fhits.length) return;
  Findex = (Findex - 1 + Fhits.length) % Fhits.length;
  gotoHit();
  updateCounter();
}

// When user types in the finder
document.getElementById("findTerm").addEventListener("input", e => {
  const term = e.target.value.trim();
  Fhits = highlightSafe(term);
  Findex = 0;
  updateCounter();
  gotoHit();
});
</script>

</body>
</html>
