<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Face Detection Results</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
body { background:#111; color:#eee; padding:20px; font-family:Arial; }
a { color:#4af; margin-right:15px; }
a:hover { text-decoration:underline; }
mark { background:yellow; color:black; }

table { width:100%; border-collapse:collapse; margin-top:20px; }
td,th { padding:8px; border-bottom:1px solid #333; }
tr:hover { background:#222; }

#finderBox {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #222;
  border: 1px solid #444;
  padding: 10px;
  border-radius: 6px;
  z-index: 9999;
}
</style>
</head>

<body>

<!-- HEADER -->
<h1 class="mb-4">Epstein Archive Search</h1>

<p>
  <a href="/">Search</a>
  <a href="/live">Live</a>
  <a href="/trump">Trump Only</a>
  <a href="/flightlogs">Flight Logs</a>
  <a href="/faces">Faces Only</a>
</p>

<!-- FINDER BOX -->
<div id="finderBox">
  <input id="findTerm" type="text" placeholder="Find…" style="width:120px;">
  <span id="findPos">0 / 0</span>
  <button onclick="findPrev()">▲</button>
  <button onclick="findNext()">▼</button>
</div>

<h2>Results Containing Detected Faces</h2>

<table class="table table-dark table-striped table-sm">
  <thead>
    <tr>
      <th>ID</th>
      <th>File</th>
      <th>Faces</th>
      <th>Face Files</th>
      <th>Keywords</th>
      <th>Snippet</th>
    </tr>
  </thead>

  <tbody>
  {% for r in rows %}
    <tr>
      <td>{{ r.id }}</td>

      <td style="max-width:300px; word-wrap:break-word;">
        {{ r.real_file }}
        <br>
        <small>Fulltext: <a href="/view/{{ r.id }}">{{ r.fulltext_file }}</a></small>
      </td>

      <td>{{ r.has_faces }}</td>

      <td style="max-width:250px; word-wrap:break-word;">
        {{ r.face_files }}
      </td>

      <td>{{ r.keywords }}</td>

      <td style="max-width:400px; word-wrap:break-word;">
        <small>{{ r.snippet }}</small>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- JAVASCRIPT: FIND + HIGHLIGHT -->
<script>
// Clear previous highlights
function clearMarks() {
  document.querySelectorAll("mark").forEach(m => {
    const parent = m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent), m);
    parent.normalize();
  });
}

// DOM-safe highlighter
function highlightSafe(term) {
  clearMarks();
  if (!term) return;

  const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    {
      acceptNode: (node) => {
        if (node.parentNode.closest('#finderBox'))
            return NodeFilter.FILTER_REJECT;

        if (node.textContent.toLowerCase().includes(term.toLowerCase()))
            return NodeFilter.FILTER_ACCEPT;

        return NodeFilter.FILTER_SKIP;
      }
    }
  );

  let node;
  while (node = walker.nextNode()) {
    const span = document.createElement("span");
    span.innerHTML = node.textContent.replace(
      new RegExp(term, "gi"),
      match => `<mark>${match}</mark>`
    );
    node.parentNode.replaceChild(span, node);
  }
}

// Navigation
let Fhits = [];
let Findex = 0;

function updateCounter() {
  if (!Fhits.length)
    document.getElementById("findPos").innerText = "0 / 0";
  else
    document.getElementById("findPos").innerText = (Findex + 1) + " / " + Fhits.length;
}

function gotoHit() {
  if (!Fhits.length) return;
  Fhits[Findex].scrollIntoView({ behavior:"smooth", block:"center" });
}

function findNext() {
  if (!Fhits.length) return;
  Findex = (Findex + 1) % Fhits.length;
  gotoHit();
  updateCounter();
}

function findPrev() {
  if (!Fhits.length) return;
  Findex = (Findex - 1 + Fhits.length) % Fhits.length;
  gotoHit();
  updateCounter();
}

// Trigger highlight
document.getElementById("findTerm").addEventListener("input", e => {
  const term = e.target.value;
  highlightSafe(term);
  Fhits = [...document.querySelectorAll("mark")];
  Findex = 0;
  updateCounter();
  gotoHit();
});
</script>

</body>
</html>
